name: Windows Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Install MinGW-w64
      shell: pwsh
      run: |
        choco install mingw -y --no-progress
        echo "C:\ProgramData\mingw64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Build native JNI libraries for Windows
      shell: bash
      run: |
        cd src/test/java/ch/technokrat/gecko/geckocircuits/nativec/testJNI_DLL
        export PATH="/c/ProgramData/mingw64/mingw64/bin:$PATH"
        gcc --version
        gcc -shared -fPIC -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/win32" -o libtestJNI_DLL.dll testJNI_DLL.c -Wl,--kill-at
        cp libtestJNI_DLL.dll libtestJNI_DLL2.dll
        echo "Native Windows DLL libraries built successfully"
        ls -lh *.dll

    - name: Build with Maven
      run: mvn clean compile -DskipTests

    - name: Run tests
      run: mvn test

    - name: Verify build
      run: mvn verify -DskipTests

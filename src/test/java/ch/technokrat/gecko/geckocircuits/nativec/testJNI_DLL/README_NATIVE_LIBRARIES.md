# Native JNI Test Libraries

This directory contains native C libraries for testing the NativeCBlock functionality.

## Platform-Specific Libraries

The native libraries are platform-specific and must be compiled separately for each operating system:

- **Windows**: `.dll` files (libtestJNI_DLL.dll, libtestJNI_DLL2.dll)
- **Linux**: `.so` files (libtestJNI_DLL.so, libtestJNI_DLL2.so)
- **macOS**: `.dylib` files (libtestJNI_DLL.dylib, libtestJNI_DLL2.dylib)

## Current Status

### Windows (x86_64)
✅ **AVAILABLE** - Built with updated JNI signatures
- Compiled using GCC 13.2.0 with MinGW
- JNI functions use correct package name: `Java_ch_technokrat_gecko_geckocircuits_nativec_*`
- Tests pass successfully

### Linux (x86_64)
⚠️ **NEEDS REBUILD** - Existing `.so` file has old JNI signatures
- The existing `libtestJNI_DLL.so` was compiled with old package name
- Must be rebuilt using the build script below

### macOS
❌ **NOT AVAILABLE** - No `.dylib` files present
- Needs to be built from source using the build script

## Building Native Libraries

### Prerequisites
- GCC compiler
- Java Development Kit (JDK) with `JAVA_HOME` set
- JNI headers (included in JDK)

### Build Script

A build script `build_native_libraries.sh` is provided to compile the libraries for your platform.

**Usage:**
```bash
cd src/test/java/ch/technokrat/gecko/geckocircuits/nativec/testJNI_DLL
chmod +x build_native_libraries.sh
./build_native_libraries.sh
```

### Manual Compilation

If the build script doesn't work for your system, you can compile manually:

#### Linux:
```bash
gcc -shared -fPIC \
  -I"$JAVA_HOME/include" \
  -I"$JAVA_HOME/include/linux" \
  -o libtestJNI_DLL.so testJNI_DLL.c
cp libtestJNI_DLL.so libtestJNI_DLL2.so
```

#### macOS:
```bash
gcc -shared -fPIC \
  -I"$JAVA_HOME/include" \
  -I"$JAVA_HOME/include/darwin" \
  -o libtestJNI_DLL.dylib testJNI_DLL.c
cp libtestJNI_DLL.dylib libtestJNI_DLL2.dylib
```

#### Windows (MinGW):
```bash
gcc -shared -fPIC \
  -I"$JAVA_HOME/include" \
  -I"$JAVA_HOME/include/win32" \
  -o libtestJNI_DLL.dll testJNI_DLL.c -Wl,--kill-at
copy libtestJNI_DLL.dll libtestJNI_DLL2.dll
```

## Testing

The `NativeCTest.java` class will:
1. Automatically detect the platform and try to load the appropriate library
2. Gracefully skip the test if the native library is not available or fails to load
3. Run successfully on Windows with the provided DLL files

Example test output on non-Windows platforms without native libraries:
```
WARNING: Native library could not be loaded. This test requires native libraries compiled for the current platform. Skipping test.
Tests run: X, Failures: 0, Errors: 0, Skipped: 2
```

## JNI Function Signatures

The native libraries must be compiled with JNI functions that use the full package name:
- `Java_ch_technokrat_gecko_geckocircuits_nativec_NativeCWrapper_calcOutputs`
- `Java_ch_technokrat_gecko_geckocircuits_nativec_NativeCWrapper_initParameters`

**Do not edit these function names** - they are generated by JNI and must match the Java package structure.

## CI/CD Considerations

For continuous integration:
1. Windows runners: Tests will run with provided DLL files
2. Linux/macOS runners: Tests will be skipped unless native libraries are pre-built or built during CI setup
3. Consider building native libraries as a CI step before running tests

## Troubleshooting

### Error: `UnsatisfiedLinkError: Native Library already loaded`
This occurs when trying to reload the same library. Restart the test JVM.

### Error: `UnsatisfiedLinkError: <function name not found>`
The native library was compiled with incorrect JNI function names. Rebuild with updated source code.

### Error: `Can't load library: <path>`
The library file doesn't exist or isn't compiled for your platform. Run the build script.

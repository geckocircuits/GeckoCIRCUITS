# GeckoCIRCUITS Docker Compose Configuration
# Local development and testing environment

version: '3.8'

services:
  # ==========================================================================
  # GeckoCIRCUITS REST API Service
  # ==========================================================================
  gecko-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: gecko-api
    ports:
      - "8080:8080"
    environment:
      - JAVA_OPTS=-Xmx2G -XX:+UseContainerSupport -Djava.awt.headless=true
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8080
    volumes:
      # Mount local circuit files directory
      - ../circuits:/app/circuits:ro
      # Mount data directory for simulation results
      - gecko-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 1G

  # ==========================================================================
  # Development Service (with hot reload - requires source mount)
  # ==========================================================================
  gecko-api-dev:
    profiles:
      - dev
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: gecko-api-dev
    ports:
      - "8080:8080"
      - "5005:5005"  # Debug port
    environment:
      - JAVA_OPTS=-Xmx2G -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
      - SPRING_PROFILES_ACTIVE=dev
    volumes:
      - ../gecko-simulation-core/src:/app/gecko-simulation-core/src:ro
      - ../gecko-rest-api/src:/app/gecko-rest-api/src:ro
      - ../circuits:/app/circuits:ro
      - gecko-data:/app/data
    restart: unless-stopped

volumes:
  gecko-data:
    driver: local

networks:
  default:
    name: gecko-network
